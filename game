<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Meme Runnerï¼šæ¢—ç‹å¤§é€ƒäº¡</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#111a33; --txt:#e8ecff; --muted:#9fb0ff;
      --good:#53ff9a; --bad:#ff5d73; --warn:#ffd166;
    }
    html,body{height:100%; margin:0; background:linear-gradient(180deg,#070a16,#0b1020 40%,#070a16); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    #wrap{display:flex; flex-direction:column; height:100%;}
    #topbar{
      display:flex; align-items:center; gap:10px; padding:10px 12px;
      background:rgba(17,26,51,.75); backdrop-filter: blur(8px);
      border-bottom:1px solid rgba(255,255,255,.08);
      flex-wrap:wrap;
    }
    .pill{padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); font-size:13px;}
    .pill b{color:#fff;}
    button{
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.07);
      color:var(--txt); border-radius:12px; padding:8px 10px; font-weight:600;
      cursor:pointer;
    }
    button:active{transform:scale(.98)}
    #game{
      position:relative; flex:1; display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    canvas{width:min(100vw,900px); height:min(100vh - 170px, 520px); border-radius:18px;
      background:
        radial-gradient(1200px 600px at 50% 120%, rgba(83,255,154,.10), transparent 60%),
        radial-gradient(900px 500px at 0% 0%, rgba(159,176,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.45);
      image-rendering: pixelated;
    }
    #overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      pointer-events:none;
    }
    .panel{
      pointer-events:auto;
      width:min(92vw,560px);
      background:rgba(17,26,51,.82);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 18px 50px rgba(0,0,0,.55);
    }
    .title{font-size:18px; font-weight:800; letter-spacing:.3px; margin:0 0 6px}
    .sub{color:var(--muted); font-size:13px; margin:0 0 12px; line-height:1.4}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      font-size:13px;
    }
    .card h4{margin:0 0 6px; font-size:14px}
    .small{font-size:12px; color:var(--muted)}
    #toast{
      position:absolute; left:50%; bottom:16px; transform:translateX(-50%);
      padding:8px 12px; border-radius:999px;
      background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.10);
      font-size:13px; opacity:0; transition:.25s; pointer-events:none;
      max-width:min(92vw,650px); text-align:center;
    }
    #danmaku{
      position:absolute; inset:0; pointer-events:none; overflow:hidden;
      border-radius:18px;
    }
    .dmsg{
      position:absolute; white-space:nowrap; font-weight:700;
      text-shadow:0 2px 10px rgba(0,0,0,.65);
      opacity:.95;
      animation: fly linear forwards;
    }
    @keyframes fly { from{transform:translateX(110%)} to{transform:translateX(-140%)} }

    /* Mobile controls */
    #mobile{
      display:none;
      position:absolute; left:0; right:0; bottom:10px;
      justify-content:space-between; padding:0 18px; pointer-events:none;
    }
    .pad{
      width:140px; height:140px; border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      position:relative;
      pointer-events:auto;
      touch-action:none;
    }
    .stick{
      width:56px; height:56px; border-radius:999px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.18);
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    }
    .ab{
      display:flex; flex-direction:column; gap:10px; pointer-events:auto;
    }
    .bigbtn{width:120px; height:56px; border-radius:16px; font-size:14px}
    @media (max-width: 900px){
      #mobile{display:flex;}
    }
  </style>
</head>
<body>
<div id="wrap">
  <div id="topbar">
    <div class="pill">ğŸ‘‘ åˆ†æ•° <b id="score">0</b></div>
    <div class="pill">â¤ï¸ å‘½ <b id="hp">3</b></div>
    <div class="pill">ğŸª™ é‡‘å¸ <b id="coin">0</b></div>
    <div class="pill">ğŸ”¥ è¿å‡» <b id="combo">0</b></div>
    <div class="pill">ğŸŒŠ éš¾åº¦ <b id="diff">1</b></div>
    <button id="btnStart">å¼€å§‹/ç»§ç»­</button>
    <button id="btnPause">æš‚åœ</button>
    <button id="btnShop">å•†åº—</button>
    <button id="btnHelp">ç©æ³•</button>
    <button id="btnMute">ğŸ”Š</button>
  </div>

  <div id="game">
    <canvas id="c" width="900" height="520"></canvas>
    <div id="danmaku"></div>
    <div id="overlay"></div>
    <div id="toast"></div>

    <!-- Mobile Controls -->
    <div id="mobile">
      <div class="pad" id="pad">
        <div class="stick" id="stick"></div>
      </div>
      <div class="ab">
        <button class="bigbtn" id="btnDash">å†²åˆº</button>
        <button class="bigbtn" id="btnBomb">æ¸…å±</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const overlay = document.getElementById('overlay');
  const danmaku = document.getElementById('danmaku');
  const toastEl = document.getElementById('toast');

  const ui = {
    score: document.getElementById('score'),
    hp: document.getElementById('hp'),
    coin: document.getElementById('coin'),
    combo: document.getElementById('combo'),
    diff: document.getElementById('diff'),
    btnStart: document.getElementById('btnStart'),
    btnPause: document.getElementById('btnPause'),
    btnShop: document.getElementById('btnShop'),
    btnHelp: document.getElementById('btnHelp'),
    btnMute: document.getElementById('btnMute'),
    btnDash: document.getElementById('btnDash'),
    btnBomb: document.getElementById('btnBomb'),
    pad: document.getElementById('pad'),
    stick: document.getElementById('stick'),
  };

  // ======= Tiny audio (beeps) =======
  let audioOn = true;
  let ac = null;
  function beep(freq=440, dur=0.06, type='sine', gain=0.04){
    if(!audioOn) return;
    try{
      if(!ac) ac = new (window.AudioContext || window.webkitAudioContext)();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(ac.destination);
      o.start();
      o.stop(ac.currentTime + dur);
    }catch(e){}
  }

  // ======= Meme content =======
  const MEME_GOOD = [
    "èŠœæ¹–èµ·é£ğŸš€","ç»ç»å­âœ¨","ç¨³å¦‚è€ç‹—ğŸ¶","æ³ªç›®ğŸ˜­","å®‰æ’ä¸Šäº†âœ…",
    "ä¸è®²æ­¦å¾·ğŸ¥Š","å¯ä»¥ä½†æ²¡å¿…è¦ğŸ™ƒ","æˆ‘ç›´æ¥ä¸€ä¸ªâ€¦ğŸ˜¤","æ‡‚çš„éƒ½æ‡‚ğŸ§","å†²å†²å†²ğŸƒ",
    "è¿™ä¸ç§‘å­¦ğŸ§ª","çˆ·é’å›ğŸ•¹ï¸","ç¬‘æ­»ğŸ¤£","ä½ ç¤¼è²Œå—ğŸ˜…","ä¸Šå¤´äº†ğŸ”¥",
    "æˆ‘æ‚Ÿäº†ğŸ§ ","æ•‘å‘½ğŸ†˜","èµ¢éº»äº†ğŸ†","å˜å˜ä¹±æ€ğŸ”ª","å¤ªçœŸå®äº†ğŸ“Œ"
  ];
  const MEME_BAD = [
    "å¯„äº†ğŸ’€","ç ´é˜²äº†ğŸ¥²","èƒŒåˆºğŸ”ª","ç¿»è½¦ğŸš—","CPUçƒ§äº†ğŸ¥µ",
    "åˆ«ææˆ‘ğŸ™","ç¦»è°±ğŸ¤¡","æˆ‘è£‚å¼€ğŸ« ","EMOäº†ğŸŒ§ï¸","æ‘†çƒ‚ğŸ˜ª"
  ];
  const MEME_DANMAKU = [
    "ä¸»æ’­åˆ«é€äº†ï¼","è¿™æ³¢è¡€èµš","æˆ‘å¥¶å¥¶éƒ½èƒ½èº²å¼€(å…¶å®ä¸èƒ½)","666666",
    "æ³¨æ„å·¦è¾¹ï¼æ³¨æ„å³è¾¹ï¼","é˜Ÿå‹å‘¢ï¼Ÿ","è¿™æŠŠç¨³äº†","æˆ‘å®£å¸ƒä½ æ˜¯æ¢—ç‹",
    "ä¸€çœ¼ä¸çœŸï¼ˆè¯¯ï¼‰","åˆ«æ€¥ï¼Œå…ˆå–å£æ°´","ä½ è¿™æ“ä½œåƒå¼€äº†åˆåƒæ²¡å¼€"
  ];
  const SKINS = [
    { id:"cat", name:"ğŸ˜º çŒ«çŒ«", price:0, glyph:"ğŸ˜º", trail:"âœ¨", desc:"é»˜è®¤çš®è‚¤ï¼šçŒ«çŒ«å†²åˆº" },
    { id:"doge", name:"ğŸ¶ Doge", price:40, glyph:"ğŸ¶", trail:"ğŸ’¨", desc:"é€Ÿåº¦+3%ï¼Œæ›´æ»‘ç¨½" },
    { id:"frog", name:"ğŸ¸ é’è›™", price:80, glyph:"ğŸ¸", trail:"ğŸ’š", desc:"è¿å‡»æ‰å¾—æ…¢ä¸€ç‚¹" },
    { id:"robot", name:"ğŸ¤– èµ›åš", price:120, glyph:"ğŸ¤–", trail:"âš¡", desc:"å†²åˆºå†·å´æ›´çŸ­" },
    { id:"king", name:"ğŸ‘‘ æ¢—ç‹", price:200, glyph:"ğŸ‘‘", trail:"ğŸ‘‘", desc:"å¾—åˆ†+5%" }
  ];

  // ======= Persistent save =======
  const SAVE_KEY = "meme_runner_save_v1";
  const save = {
    coins: 0,
    best: 0,
    owned: { cat:true },
    skin: "cat",
    ach: {}
  };
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem(SAVE_KEY)||"null");
      if(s){
        Object.assign(save, s);
        save.owned = save.owned || {cat:true};
        if(!save.owned.cat) save.owned.cat = true;
        save.skin = save.skin || "cat";
      }
    }catch(e){}
  }
  function persist(){
    try{ localStorage.setItem(SAVE_KEY, JSON.stringify(save)); }catch(e){}
  }
  load();

  // ======= Game state =======
  const W = canvas.width, H = canvas.height;
  const rng = (a,b)=> a + Math.random()*(b-a);

  const keys = new Set();
  let running = false;
  let paused = false;
  let lastTime = performance.now();

  const state = {
    score:0,
    hp:3,
    coins:save.coins,
    combo:0,
    diff:1,
    time:0,
    bomb:1,
    dashCd:0,
    dashTime:0,
    inv:0,
    shake:0,
    wave:0,
  };

  const player = {
    x: W*0.18,
    y: H*0.55,
    r: 18,
    vx:0, vy:0,
    speed: 260,
  };

  const entities = []; // obstacles + goodies
  const particles = [];
  const floatTexts = [];

  function skinObj(){ return SKINS.find(s=>s.id===save.skin) || SKINS[0]; }

  // ======= Achievements =======
  const ACH = [
    { id:"firstblood", name:"ç¬¬ä¸€æ¬¡å°±ä¸Šå¤´", desc:"åˆ†æ•°è¾¾åˆ° 200", check:()=> state.score>=200 },
    { id:"combo10", name:"è¿å‡»å°å­", desc:"è¿å‡»è¾¾åˆ° 10", check:()=> state.combo>=10 },
    { id:"rich", name:"é‡‘å¸æˆ˜ç¥", desc:"ç´¯è®¡é‡‘å¸è¾¾åˆ° 200", check:()=> state.coins>=200 },
    { id:"survive60", name:"è‹Ÿä½å°±èƒ½èµ¢", desc:"å­˜æ´» 60 ç§’", check:()=> state.time>=60 },
    { id:"diff8", name:"éš¾åº¦æ‹‰æ»¡", desc:"éš¾åº¦è¾¾åˆ° 8", check:()=> state.diff>=8 },
  ];
  function unlockAch(id){
    if(save.ach[id]) return;
    save.ach[id]=true;
    persist();
    toast("ğŸ… æˆå°±è§£é”ï¼š" + (ACH.find(a=>a.id===id)?.name || id));
    danmakuPush("æˆå°±è§£é”ï¼"+(ACH.find(a=>a.id===id)?.name||""));
    beep(880,0.08,'square',0.05);
  }
  function checkAch(){
    for(const a of ACH){
      if(!save.ach[a.id] && a.check()) unlockAch(a.id);
    }
  }

  // ======= UI helpers =======
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.opacity = 1;
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.opacity=0, 1200);
  }
  function danmakuPush(text){
    const el = document.createElement('div');
    el.className = 'dmsg';
    el.textContent = text;
    el.style.top = Math.floor(rng(10, H-40))+"px";
    el.style.fontSize = Math.floor(rng(14,22))+"px";
    el.style.animationDuration = rng(4.2, 7.2)+"s";
    el.style.color = `hsl(${Math.floor(rng(0,360))} 90% 75%)`;
    danmaku.appendChild(el);
    el.addEventListener('animationend', ()=> el.remove());
  }

  function showPanel(html){
    overlay.innerHTML = `<div class="panel">${html}</div>`;
  }
  function hidePanel(){ overlay.innerHTML = ""; }

  // ======= Spawning =======
  function spawn(type){
    const fromRight = W + 40;
    const y = rng(50, H-50);
    if(type==="bad"){
      const kind = Math.random();
      let glyph = "ğŸ’£";
      if(kind<0.25) glyph="ğŸ§¨";
      else if(kind<0.50) glyph="ğŸª¨";
      else if(kind<0.75) glyph="ğŸ˜ˆ";
      else glyph="ğŸ’€";
      entities.push({
        type:"bad",
        x: fromRight,
        y,
        r: rng(16, 26),
        vx: -rng(170, 260) * (1 + state.diff*0.06),
        glyph,
        dmg:1
      });
    } else if(type==="coin"){
      entities.push({
        type:"coin",
        x: fromRight,
        y,
        r: 14,
        vx: -rng(150, 220) * (1 + state.diff*0.04),
        glyph:"ğŸª™",
        val: 1
      });
    } else if(type==="heart"){
      entities.push({
        type:"heart",
        x: fromRight,
        y,
        r: 16,
        vx: -rng(150, 210),
        glyph:"â¤ï¸",
        val: 1
      });
    } else if(type==="meme"){
      // meme buff: score/combo
      const glyph = ["ğŸ“ˆ","ğŸ§ ","âœ¨","ğŸ”¥","ğŸ§‹"][Math.floor(rng(0,5))];
      entities.push({
        type:"meme",
        x: fromRight,
        y,
        r: 16,
        vx: -rng(160, 230),
        glyph,
        val: 1
      });
    }
  }

  // ======= Controls =======
  window.addEventListener('keydown', e=>{
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," ","Enter","Escape"].includes(e.key)) e.preventDefault();
    keys.add(e.key);
    if(e.key==="Escape") togglePause();
    if(e.key===" ") doDash();
    if(e.key==="Enter") startOrResume();
    if(e.key.toLowerCase()==="b") doBomb();
  }, {passive:false});

  window.addEventListener('keyup', e=> keys.delete(e.key));

  // Touch joystick
  let joy = {active:false, dx:0, dy:0};
  function setStick(dx,dy){
    const max = 44;
    const len = Math.hypot(dx,dy);
    const k = len>max ? max/len : 1;
    const x = dx*k, y = dy*k;
    ui.stick.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
  }
  ui.pad.addEventListener('pointerdown', e=>{
    joy.active=true; ui.pad.setPointerCapture(e.pointerId);
    joy.ox = e.clientX; joy.oy = e.clientY;
    joy.dx=0; joy.dy=0;
    setStick(0,0);
  });
  ui.pad.addEventListener('pointermove', e=>{
    if(!joy.active) return;
    joy.dx = e.clientX - joy.ox;
    joy.dy = e.clientY - joy.oy;
    setStick(joy.dx, joy.dy);
  });
  ui.pad.addEventListener('pointerup', e=>{
    joy.active=false; joy.dx=0; joy.dy=0;
    setStick(0,0);
  });

  ui.btnDash.addEventListener('click', doDash);
  ui.btnBomb.addEventListener('click', doBomb);

  function inputVec(){
    let x=0,y=0;
    if(keys.has("ArrowLeft")||keys.has("a")||keys.has("A")) x-=1;
    if(keys.has("ArrowRight")||keys.has("d")||keys.has("D")) x+=1;
    if(keys.has("ArrowUp")||keys.has("w")||keys.has("W")) y-=1;
    if(keys.has("ArrowDown")||keys.has("s")||keys.has("S")) y+=1;
    if(joy.active){
      const max = 60;
      x += Math.max(-1, Math.min(1, joy.dx/max));
      y += Math.max(-1, Math.min(1, joy.dy/max));
    }
    const len=Math.hypot(x,y);
    if(len>1){ x/=len; y/=len; }
    return {x,y};
  }

  // ======= Actions =======
  function doDash(){
    if(!running || paused) return;
    const sk = skinObj();
    const baseCd = 2.8;
    const cd = sk.id==="robot" ? baseCd*0.75 : baseCd;
    if(state.dashCd>0) { toast("å†²åˆºå†·å´ä¸­â€¦"); return; }
    state.dashTime = 0.22;
    state.dashCd = cd;
    state.inv = Math.max(state.inv, 0.28);
    beep(740,0.06,'sawtooth',0.05);
    danmakuPush("å†²åˆºï¼èŠœæ¹–èµ·é£ğŸš€");
  }
  function doBomb(){
    if(!running || paused) return;
    if(state.bomb<=0){ toast("æ¸…å±æ¬¡æ•°ç”¨å®Œäº†"); return; }
    state.bomb--;
    // clear nearby enemies
    let cleared=0;
    for(let i=entities.length-1;i>=0;i--){
      if(entities[i].type==="bad"){
        entities.splice(i,1);
        cleared++;
      }
    }
    state.score += cleared*25;
    state.combo = Math.min(30, state.combo + Math.min(10, Math.floor(cleared/2)));
    state.shake = 10;
    for(let i=0;i<40;i++){
      particles.push({x:rng(0,W),y:rng(0,H),vx:rng(-120,120),vy:rng(-120,120),life:rng(0.3,0.8),t:0,chr:"ğŸ’¥"});
    }
    beep(120,0.12,'square',0.06);
    toast(`ğŸ’¥ æ¸…å±ï¼æ¶ˆç­ ${cleared} ä¸ªâ€œç¦»è°±â€`);
    danmakuPush("è¿™æ³¢ï¼šä¸€é”®æ¸…å±ï¼");
  }

  // ======= Game flow =======
  function resetRun(){
    state.score=0; state.hp=3; state.combo=0; state.diff=1; state.time=0;
    state.bomb=1; state.dashCd=0; state.dashTime=0; state.inv=0; state.shake=0; state.wave=0;
    player.x=W*0.18; player.y=H*0.55; player.vx=0; player.vy=0;
    entities.length=0; particles.length=0; floatTexts.length=0;
  }

  function startOrResume(){
    if(!running){
      resetRun();
      running = true; paused=false;
      hidePanel();
      toast("å¼€å±€ï¼šåˆ«ç ´é˜²ï¼Œå…ˆæ´»ç€ï¼");
      danmakuPush("å¼€äº†å¼€äº†ï¼");
      lastTime = performance.now();
      beep(660,0.06,'triangle',0.05);
      requestAnimationFrame(loop);
      return;
    }
    if(paused) togglePause(false);
  }

  function togglePause(force){
    if(!running) return;
    paused = (typeof force==="boolean") ? force : !paused;
    if(paused){
      showPause();
    }else{
      hidePanel();
      lastTime = performance.now();
      requestAnimationFrame(loop);
    }
  }

  function gameOver(){
    running=false; paused=false;

    // save best + coins
    save.coins = state.coins;
    save.best = Math.max(save.best, state.score);
    persist();

    const best = save.best;
    const achList = ACH.map(a => `<div class="card"><h4>${save.ach[a.id]?"âœ…":"â¬œ"} ${a.name}</h4><div class="small">${a.desc}</div></div>`).join("");

    showPanel(`
      <div class="title">ğŸ’€ å¯„äº†ï¼Œä½†ä¸äº</div>
      <p class="sub">æœ¬å±€åˆ†æ•° <b>${state.score}</b> ï½œæœ€é«˜åˆ† <b>${best}</b> ï½œé‡‘å¸ <b>${state.coins}</b></p>
      <div class="grid">${achList}</div>
      <div style="height:10px"></div>
      <div class="row">
        <button id="r1">å†æ¥ä¸€æŠŠ</button>
        <button id="r2">å•†åº—/æ¢çš®è‚¤</button>
        <button id="r3">ç©æ³•</button>
      </div>
      <p class="small" style="margin-top:10px">æç¤ºï¼šæŒ‰ Enter å¼€å§‹ï¼›ç©ºæ ¼å†²åˆºï¼›B æ¸…å±ï¼›Esc æš‚åœã€‚</p>
    `);

    document.getElementById('r1').onclick = ()=> { hidePanel(); startOrResume(); };
    document.getElementById('r2').onclick = ()=> showShop();
    document.getElementById('r3').onclick = ()=> showHelp();
    danmakuPush(MEME_BAD[Math.floor(rng(0,MEME_BAD.length))]);
    beep(180,0.14,'square',0.06);
  }

  // ======= Panels =======
  function showPause(){
    showPanel(`
      <div class="title">â¸ï¸ æš‚åœï¼šåˆ«æ€¥ï¼Œå…ˆæ·±å‘¼å¸</div>
      <p class="sub">æŒ‰ Esc / ç‚¹â€œæš‚åœâ€ç»§ç»­ã€‚ä½ ä¹Ÿå¯ä»¥å…ˆå»å•†åº—å½“ä¸€ä¼šå„¿â€œæ°ªé‡‘ç©å®¶â€ã€‚</p>
      <div class="row">
        <button id="p1">ç»§ç»­</button>
        <button id="p2">å•†åº—</button>
        <button id="p3">ç©æ³•</button>
      </div>
    `);
    document.getElementById('p1').onclick = ()=> togglePause(false);
    document.getElementById('p2').onclick = ()=> showShop(true);
    document.getElementById('p3').onclick = ()=> showHelp(true);
  }

  function showHelp(fromPause=false){
    const sk = skinObj();
    showPanel(`
      <div class="title">ğŸ“œ ç©æ³•è¯´æ˜ï¼ˆæ¢—å¤šä½†ä¸éš¾ï¼‰</div>
      <div class="card">
        <h4>ç›®æ ‡</h4>
        <div class="small">èº²é¿â€œç¦»è°±ç‰©â€ï¼ˆğŸ’€ğŸ˜ˆğŸ§¨ğŸª¨ï¼‰ï¼Œæ”¶é›† ğŸª™é‡‘å¸ / âœ¨æ¢—èƒ½é‡ / â¤ï¸å›è¡€ï¼Œåˆ†æ•°è¶Šé«˜éš¾åº¦è¶Šé«˜ã€‚</div>
      </div>
      <div style="height:10px"></div>
      <div class="grid">
        <div class="card">
          <h4>æ“ä½œ</h4>
          <div class="small">
            ç”µè„‘ï¼šæ–¹å‘é”®/WASDç§»åŠ¨ï½œç©ºæ ¼å†²åˆºï½œBæ¸…å±ï½œEnterå¼€å±€ï½œEscæš‚åœ<br/>
            æ‰‹æœºï¼šå·¦æ‘‡æ†ç§»åŠ¨ï½œå³ä¾§æŒ‰é’®å†²åˆº/æ¸…å±
          </div>
        </div>
        <div class="card">
          <h4>å½“å‰çš®è‚¤</h4>
          <div class="small">${sk.name}ï¼š${sk.desc}</div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="card">
        <h4>æ¢—æœºåˆ¶</h4>
        <div class="small">
          è¿å‡»è¶Šé«˜ï¼šå¾—åˆ†è¶Šå¿«ï¼›æ’åˆ°æ•Œäººï¼šæ‰å‘½å¹¶æ¸…ç©ºè¿å‡»ï¼ˆé™¤éæ— æ•Œï¼‰ã€‚<br/>
          å†²åˆºæœŸé—´çŸ­æš‚æ— æ•Œï¼›æ¸…å±ä¼šç»™åˆ†+è¿å‡»ï¼Œä½†æ¬¡æ•°æœ‰é™ã€‚
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <button id="h1">${fromPause?"è¿”å›æš‚åœ":"å¼€å§‹æ¸¸æˆ"}</button>
        <button id="h2">å•†åº—</button>
      </div>
    `);
    document.getElementById('h1').onclick = ()=> {
      if(fromPause) showPause();
      else { hidePanel(); startOrResume(); }
    };
    document.getElementById('h2').onclick = ()=> showShop(fromPause);
  }

  function showShop(fromPause=false){
    const list = SKINS.map(s=>{
      const owned = !!save.owned[s.id];
      const isOn = save.skin===s.id;
      const canBuy = state.coins>=s.price;
      const btn = owned
        ? `<button data-equip="${s.id}">${isOn?"å·²è£…å¤‡âœ…":"è£…å¤‡"}</button>`
        : `<button data-buy="${s.id}" ${canBuy?"":"disabled"}>${canBuy?`è´­ä¹° ${s.price}ğŸª™`:`ç¼º ${s.price-state.coins}ğŸª™`}</button>`;
      return `
        <div class="card">
          <h4>${s.name} ${owned?"âœ…":""}</h4>
          <div class="small">${s.desc}<br/>ä»·æ ¼ï¼š${s.price}ğŸª™</div>
          <div style="height:8px"></div>
          ${btn}
        </div>
      `;
    }).join("");

    const ach = ACH.map(a => `<div class="card"><h4>${save.ach[a.id]?"âœ…":"â¬œ"} ${a.name}</h4><div class="small">${a.desc}</div></div>`).join("");

    showPanel(`
      <div class="title">ğŸ›’ æ¢—çš®è‚¤å•†åº—ï¼ˆä¸æ°ªä¹Ÿèƒ½èµ¢ï¼‰</div>
      <p class="sub">é‡‘å¸ï¼š<b>${state.coins}</b> ï½œæœ€é«˜åˆ†ï¼š<b>${save.best}</b></p>
      <div class="grid">${list}</div>
      <div style="height:10px"></div>
      <div class="title" style="font-size:16px">ğŸ… æˆå°±</div>
      <div class="grid">${ach}</div>
      <div style="height:10px"></div>
      <div class="row">
        <button id="s1">${fromPause?"è¿”å›æš‚åœ":"ç»§ç»­æ¸¸æˆ"}</button>
        <button id="s2">ç©æ³•</button>
        <button id="s3">é‡ç½®å­˜æ¡£(æ…ç‚¹)</button>
      </div>
      <p class="small" style="margin-top:10px">æç¤ºï¼šè£…å¤‡ä¸åŒçš®è‚¤ä¼šæ”¹å˜å°‘é‡æ•°å€¼ï¼ˆä¸ä¼šå¤ªç ´åå¹³è¡¡ï¼‰ã€‚</p>
    `);

    overlay.querySelectorAll('[data-buy]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-buy');
        const s = SKINS.find(x=>x.id===id);
        if(!s) return;
        if(state.coins < s.price) { toast("é‡‘å¸ä¸å¤Ÿï¼Œå…ˆå»å˜å˜ä¹±æ€"); return; }
        state.coins -= s.price;
        save.owned[id]=true;
        save.coins = state.coins;
        persist();
        beep(520,0.07,'triangle',0.05);
        toast("è´­ä¹°æˆåŠŸï¼š"+s.name);
        showShop(fromPause);
      };
    });
    overlay.querySelectorAll('[data-equip]').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-equip');
        if(!save.owned[id]) return;
        save.skin = id;
        persist();
        beep(620,0.06,'sine',0.05);
        toast("å·²è£…å¤‡ï¼š"+(SKINS.find(x=>x.id===id)?.name||id));
        showShop(fromPause);
      };
    });

    document.getElementById('s1').onclick = ()=> {
      if(fromPause) showPause();
      else { hidePanel(); if(!running) startOrResume(); }
    };
    document.getElementById('s2').onclick = ()=> showHelp(fromPause);
    document.getElementById('s3').onclick = ()=> {
      // no confirm to keep simple; still do quick safety via double click
      if(!btnDoubleGuard()) return;
      localStorage.removeItem(SAVE_KEY);
      toast("å­˜æ¡£å·²é‡ç½®ï¼ˆçˆ·é’ç»“ï¼‰");
      location.reload();
    };
  }

  // double-click guard
  let _guardT = 0;
  function btnDoubleGuard(){
    const now = performance.now();
    if(now - _guardT < 900) return true;
    _guardT = now;
    toast("å†ç‚¹ä¸€æ¬¡ç¡®è®¤é‡ç½®");
    return false;
  }

  // ======= Collisions =======
  function hit(a,b){
    const dx=a.x-b.x, dy=a.y-b.y;
    return (dx*dx+dy*dy) <= (a.r+b.r)*(a.r+b.r);
  }

  function addFloat(x,y,text,good=true){
    floatTexts.push({x,y,text,life:1.0,t:0,good});
  }

  // ======= Update and render =======
  function update(dt){
    state.time += dt;
    // difficulty ramp
    state.diff = 1 + Math.floor(state.time/10);
    ui.diff.textContent = state.diff;

    const sk = skinObj();
    const speedBonus = (sk.id==="doge")? 1.03 : 1.0;
    const scoreBonus = (sk.id==="king")? 1.05 : 1.0;

    // cooldowns
    if(state.dashCd>0) state.dashCd = Math.max(0, state.dashCd - dt);
    if(state.dashTime>0) state.dashTime = Math.max(0, state.dashTime - dt);
    if(state.inv>0) state.inv = Math.max(0, state.inv - dt);
    if(state.shake>0) state.shake = Math.max(0, state.shake - dt*60);

    // movement
    const iv = inputVec();
    const dashBoost = state.dashTime>0 ? 1.9 : 1.0;
    const sp = player.speed * speedBonus * dashBoost;

    player.vx = iv.x * sp;
    player.vy = iv.y * sp;

    player.x += player.vx * dt;
    player.y += player.vy * dt;

    // bounds
    player.x = Math.max(player.r, Math.min(W-player.r, player.x));
    player.y = Math.max(player.r, Math.min(H-player.r, player.y));

    // spawn wave
    state.wave += dt;
    const baseRate = 0.55; // lower -> more spawns
    const rate = Math.max(0.18, baseRate - state.diff*0.04);
    if(state.wave >= rate){
      state.wave = 0;
      // choose
      const roll = Math.random();
      if(roll < 0.63) spawn("bad");
      else if(roll < 0.88) spawn("coin");
      else if(roll < 0.96) spawn("meme");
      else spawn("heart");
      // sometimes extra
      if(state.diff>=5 && Math.random()<0.25) spawn(Math.random()<0.7?"bad":"coin");
    }

    // update entities
    for(let i=entities.length-1;i>=0;i--){
      const e = entities[i];
      e.x += e.vx * dt;

      // remove offscreen
      if(e.x < -60){ entities.splice(i,1); continue; }

      // collision
      if(hit(player,e)){
        if(e.type==="bad"){
          if(state.inv>0){
            // ignore + bonus
            state.score += 8;
            addFloat(player.x, player.y-10, "æ— æ•Œï¼šèµ¢éº»äº†ğŸ†", true);
            beep(800,0.04,'triangle',0.04);
            entities.splice(i,1);
            continue;
          }
          state.hp -= e.dmg;
          state.combo = 0;
          state.inv = 0.85;
          state.shake = 14;
          addFloat(player.x, player.y-10, MEME_BAD[Math.floor(rng(0,MEME_BAD.length))], false);
          danmakuPush("ç ´é˜²äº†ï¼æ³¨æ„èµ°ä½ï¼");
          beep(140,0.10,'square',0.06);
          entities.splice(i,1);
          if(state.hp<=0){
            checkAch();
            gameOver();
            return;
          }
        } else if(e.type==="coin"){
          state.coins += e.val;
          state.score += Math.floor((10 + state.combo*2) * scoreBonus);
          state.combo = Math.min(30, state.combo+1);
          addFloat(e.x, e.y-10, "ğŸª™ +1", true);
          if(Math.random()<0.25) danmakuPush(MEME_GOOD[Math.floor(rng(0,MEME_GOOD.length))]);
          beep(520,0.04,'sine',0.04);
          entities.splice(i,1);
        } else if(e.type==="heart"){
          state.hp = Math.min(5, state.hp + e.val);
          state.score += Math.floor(30 * scoreBonus);
          addFloat(e.x, e.y-10, "â¤ï¸ +1 å‘½", true);
          danmakuPush("å›è¡€ï¼ç¨³ä½ï¼");
          beep(660,0.05,'triangle',0.05);
          entities.splice(i,1);
        } else if(e.type==="meme"){
          // meme buff: score & combo
          state.score += Math.floor((35 + state.combo*3) * scoreBonus);
          state.combo = Math.min(30, state.combo + 2);
          addFloat(e.x, e.y-10, "âœ¨ æ¢—èƒ½é‡ +2è¿å‡»", true);
          danmakuPush(MEME_GOOD[Math.floor(rng(0,MEME_GOOD.length))]);
          beep(740,0.05,'sawtooth',0.045);
          entities.splice(i,1);
        }
      }
    }

    // combo decay (frog skin slows it)
    const decay = (sk.id==="frog") ? 0.25 : 0.42;
    if(state.combo>0 && Math.random()< dt*decay){
      state.combo = Math.max(0, state.combo-1);
    }

    // passive score
    state.score += Math.floor(dt * (8 + state.diff*1.2) * scoreBonus);

    // particles
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.t += dt; p.x += p.vx*dt; p.y += p.vy*dt;
      if(p.t>p.life) particles.splice(i,1);
    }
    // float texts
    for(let i=floatTexts.length-1;i>=0;i--){
      const f=floatTexts[i];
      f.t += dt;
      f.y -= 18*dt;
      if(f.t>f.life) floatTexts.splice(i,1);
    }

    // occasional danmaku
    if(Math.random() < dt*0.45){
      danmakuPush(MEME_DANMAKU[Math.floor(rng(0,MEME_DANMAKU.length))]);
    }

    // update UI
    ui.score.textContent = state.score;
    ui.hp.textContent = state.hp;
    ui.coin.textContent = state.coins;
    ui.combo.textContent = state.combo;

    // update save coins
    save.coins = state.coins;
    persist();

    checkAch();
  }

  function draw(){
    // screen shake
    let sx=0, sy=0;
    if(state.shake>0){
      sx = rng(-state.shake, state.shake);
      sy = rng(-state.shake, state.shake);
    }
    ctx.save();
    ctx.translate(sx, sy);

    // clear
    ctx.clearRect(-50,-50,W+100,H+100);

    // background grid
    ctx.globalAlpha=0.18;
    ctx.strokeStyle="#9fb0ff";
    ctx.lineWidth=1;
    for(let x=0;x<=W;x+=45){
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
    }
    for(let y=0;y<=H;y+=45){
      ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke();
    }
    ctx.globalAlpha=1;

    // lanes glow
    ctx.globalAlpha=0.08;
    for(let i=0;i<6;i++){
      const yy = (i+1)*H/7;
      ctx.beginPath();
      ctx.arc(W*0.5, yy, 380, 0, Math.PI*2);
      ctx.strokeStyle="#53ff9a";
      ctx.stroke();
    }
    ctx.globalAlpha=1;

    // entities
    ctx.font = "26px system-ui, Apple Color Emoji, Segoe UI Emoji";
    for(const e of entities){
      ctx.save();
      ctx.translate(e.x, e.y);
      // shadow ring
      ctx.globalAlpha=0.25;
      ctx.beginPath();
      ctx.arc(0,0,e.r+6,0,Math.PI*2);
      ctx.fillStyle = e.type==="bad" ? "#ff5d73" : (e.type==="coin" ? "#ffd166" : "#53ff9a");
      ctx.fill();
      ctx.globalAlpha=1;
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText(e.glyph, 0, 1);
      ctx.restore();
    }

    // player
    const sk = skinObj();
    const glow = (state.inv>0) ? 0.45 : 0.25;
    ctx.save();
    ctx.translate(player.x, player.y);

    // trail
    ctx.globalAlpha=0.20;
    for(let i=0;i<6;i++){
      ctx.fillText(sk.trail, -18 - i*14, (i%2?-6:6));
    }
    ctx.globalAlpha=1;

    // aura
    ctx.globalAlpha = glow;
    ctx.beginPath();
    ctx.arc(0,0, player.r+10, 0, Math.PI*2);
    ctx.fillStyle = (state.inv>0) ? "#53ff9a" : "#9fb0ff";
    ctx.fill();
    ctx.globalAlpha=1;

    // glyph
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.font = "34px system-ui, Apple Color Emoji, Segoe UI Emoji";
    ctx.fillText(sk.glyph, 0, 2);

    // dash hint
    ctx.font = "14px system-ui";
    ctx.fillStyle = "rgba(232,236,255,.85)";
    const dashTxt = state.dashCd>0 ? `å†²åˆºCD ${state.dashCd.toFixed(1)}s` : "ç©ºæ ¼/æŒ‰é’®ï¼šå†²åˆº";
    ctx.fillText(dashTxt, 0, -32);

    // bomb
    ctx.fillStyle="rgba(255,255,255,.80)";
    ctx.fillText(`æ¸…å±Ã—${state.bomb} (B)`, 0, 40);

    ctx.restore();

    // particles
    ctx.font = "22px system-ui, Apple Color Emoji, Segoe UI Emoji";
    for(const p of particles){
      const a = 1 - (p.t/p.life);
      ctx.globalAlpha = a;
      ctx.fillText(p.chr, p.x, p.y);
    }
    ctx.globalAlpha=1;

    // float texts
    for(const f of floatTexts){
      const a = 1 - (f.t/f.life);
      ctx.globalAlpha=a;
      ctx.font = "16px system-ui";
      ctx.fillStyle = f.good ? "rgba(83,255,154,.95)" : "rgba(255,93,115,.95)";
      ctx.textAlign="center";
      ctx.fillText(f.text, f.x, f.y);
    }
    ctx.globalAlpha=1;

    // HUD hints
    ctx.font = "14px system-ui";
    ctx.fillStyle="rgba(232,236,255,.75)";
    ctx.textAlign="left"; ctx.textBaseline="top";
    ctx.fillText("ç›®æ ‡ï¼šèº²é¿ğŸ’€ğŸ˜ˆğŸ§¨ğŸª¨ï¼Œæ”¶é›†ğŸª™âœ¨â¤ï¸ã€‚Enterå¼€å§‹ï¼ŒEscæš‚åœã€‚", 12, 12);

    ctx.restore();
  }

  function loop(now){
    if(!running || paused) return;
    const dt = Math.min(0.033, (now - lastTime)/1000);
    lastTime = now;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }

  // ======= Buttons =======
  ui.btnStart.onclick = startOrResume;
  ui.btnPause.onclick = ()=> togglePause();
  ui.btnShop.onclick = ()=> showShop(paused);
  ui.btnHelp.onclick = ()=> showHelp(paused);
  ui.btnMute.onclick = ()=>{
    audioOn = !audioOn;
    ui.btnMute.textContent = audioOn ? "ğŸ”Š" : "ğŸ”‡";
    toast(audioOn?"å£°éŸ³å·²å¼€å¯":"å£°éŸ³å·²å…³é—­");
  };

  // ======= Start screen =======
  showPanel(`
    <div class="title">ğŸ® Meme Runnerï¼šæ¢—ç‹å¤§é€ƒäº¡</div>
    <p class="sub">ä¸€ä¸ªâ€œå…¨æ˜¯æ¢—â€çš„ 2D èº²é¿æ”¶é›†æ¸¸æˆï¼šè¶Šæ´»è¶Šéš¾ï¼Œè¶Šç©è¶Šä¸Šå¤´ã€‚</p>
    <div class="grid">
      <div class="card">
        <h4>å¿«é€Ÿå¼€å§‹</h4>
        <div class="small">æŒ‰ <b>Enter</b> æˆ–ç‚¹â€œå¼€å§‹â€ã€‚ç”µè„‘ç”¨æ–¹å‘é”®/WASDï¼Œç©ºæ ¼å†²åˆºï¼ŒBæ¸…å±ï¼ŒEscæš‚åœã€‚</div>
      </div>
      <div class="card">
        <h4>ä½ çš„å­˜æ¡£</h4>
        <div class="small">æœ€é«˜åˆ†ï¼š<b>${save.best}</b> ï½œé‡‘å¸ï¼š<b>${save.coins}</b> ï½œå½“å‰çš®è‚¤ï¼š<b>${skinObj().name}</b></div>
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button id="g1">å¼€å§‹æ¸¸æˆ</button>
      <button id="g2">å•†åº—</button>
      <button id="g3">ç©æ³•</button>
    </div>
    <p class="small" style="margin-top:10px">æç¤ºï¼šæµè§ˆå™¨å…¨å±ä½“éªŒæ›´çˆ½ã€‚æ‰‹æœºå·¦æ‘‡æ†ç§»åŠ¨ï¼Œå³ä¾§æŒ‰é’®å†²åˆº/æ¸…å±ã€‚</p>
  `);
  document.getElementById('g1').onclick = ()=> { hidePanel(); startOrResume(); };
  document.getElementById('g2').onclick = ()=> showShop(false);
  document.getElementById('g3').onclick = ()=> showHelp(false);

})();
</script>
</body>
</html>
